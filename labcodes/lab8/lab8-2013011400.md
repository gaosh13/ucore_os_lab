## 练习题

---

### 练习0

使用meld工具图形化界面比较lab6和lab7添加。

在alloc_proc函数中需要新增对filesp的初始化，do_fork中新增文件系统的复制，使用到函数copy_files。

---

### 练习1

#### sfs_io_nolock实现

按照提示，读取被分为了三部分。第一个block可能没有块对齐，可能要读取未对齐的部分。首先使用sfs_bmap_load_nolock获得inode。然后通过offset确定读取长度，并通过sys_buf_op读取数据。第三部分对最后一个block的处理与此类似。

第二部分可能包含若干各整块的数据，与第一部分的不同在于使用了sys_block_op的接口来读取整个块。

#### PIPE实现方法

增加接口pipe_new，pipe_read和pipe_write，表示管道的新建、读入、输出。管道内维护读写指针、缓冲区，缓冲区可以用循环队列的思想实现，读或写操作将对应指针后移一个单位（移到队尾后移回队首），若指针重合说明缓冲区为空，若读位于写的后一个单位则表示缓冲区满。此外由于需要满足读写互斥的操作，在写的时候需要加入互斥锁（可以用一个信号量完成）。

---

### 练习2

#### load_icode实现

load_icode需要从磁盘读取binary，读取ELF、程序数据段、代码段时用到了load_icode_read函数。内存的处理与之前的练习类似，设置页表项cr3寄存器等。

此外，由于要传递参数，所以需要设置堆栈，参数为字符串，所以堆栈自顶到底的顺序存储这些参数的个数、字符串的地址、字符串的数据，将栈顶放在当前进程trapframe的tf_esp中。此后就可以使用sh运行用户程序了。

#### UNIX的硬链接和软链接

当前的框架可以实现硬链接和软链接。

对于硬链接，考虑到sfs.h中sfs_disk_inode中已有nlinks计数，表示硬链接到此文件的个数，当删除各个硬链接至nlinks为0时该文件即可彻底删除。

对于软链接，考虑到sfs.h中有类型SFS_TYPE_LINK可作为文件的类型，可以将文件的地址保存在sfs_disk_inode的direct[0]的block中。